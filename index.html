<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Bulk Image Downloader โ Pro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="topbar container">
    <h1 class="app-title">Bulk Image Downloader โ Pro</h1>
    <div class="top-actions">
      <div class="mode-switch">
        <label class="chk">
          <input type="checkbox" id="advancedMode">
          <span>ูุถุน ูุชูุฏู</span>
        </label>
      </div>
      <button id="helpBtn" class="btn-ghost">ุ ุชุนูููุงุช</button>
    </div>
  </header>

  <main class="container layout">
    <!-- LEFT -->
    <section class="col main">
      <!-- Upload -->
      <section class="card">
        <p class="sub">ุงุฑูุน ููู Excel/CSV ููู <strong>ููุฏ ุงูููุชุฌ</strong> ู<strong>ุฑูุงุจุท ุงูุตูุฑ</strong>. ูููู ุชุญูุธ ZIP ูุญูููุง ุฃู ุชุฑูุน ุฅูู ุฌูุฌู ุฏุฑุงูู.</p>
        <div class="upload-wrap">
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" hidden />
          <label for="fileInput" id="fileLabel" class="dropzone">
            <div class="dz-illustration">๐โฌ๏ธ</div>
            <div class="dz-text">
              <div class="dz-title">ุงุณุญุจ ูุงููุช ุงูููู ููุง</div>
              <div class="dz-sub">ุฃู ุงุถุบุท ูุงุฎุชูุงุฑ ููู</div>
            </div>
            <div class="dz-badges"><span class="badge mini">.xlsx</span><span class="badge mini">.xls</span><span class="badge mini">.csv</span></div>
            <div class="dz-meta"><span id="fileName" class="muted">ูุง ููุฌุฏ ููู</span><span id="fileMeta" class="muted"></span></div>
          </label>
        </div>

        <div class="actions-row">
          <button id="previewBtn" class="btn-secondary" disabled>ูุนุงููุฉ</button>
          <button id="estimateBtn" class="btn-secondary" disabled>ุญุณุงุจ ุงููุณุงุญุฉ</button>
          <button id="startBtn" disabled>ุงุจุฏุฃ</button>
        </div>
      </section>

      <!-- Tasks -->
      <section class="card">
        <h3 class="section-title">ุงุฎุชุฑ ุงูููุงู</h3>
        <div class="grid three">
          <label class="chk"><input type="checkbox" id="taskDownload" checked><span>ุชุญููู ูุญูู (ZIP)</span></label>
          <label class="chk"><input type="checkbox" id="taskDrivePics"><span>ุฑูุน ุตูุฑ ูููุตูุฉ ุฅูู ุฏุฑุงูู</span></label>
          <label class="chk"><input type="checkbox" id="taskDriveZips"><span>ุฑูุน ูููุงุช ZIP ุฅูู ุฏุฑุงูู</span></label>
        </div>
        <small class="muted">ูููู ุชูููุฐ ุฃูุซุฑ ูู ูููุฉ ุจุงูุชุชุงุจุน.</small>
      </section>

      <!-- Progress (above dashboard) -->
      <section class="card">
        <h3 class="section-title">ุงูุชูุฏู</h3>
        <div class="controls-row">
          <button id="pauseBtn" class="btn-ghost" disabled>ุงููุงู ูุคูุช</button>
          <button id="resumeBtn" class="btn-ghost" disabled>ุงุณุชููุงู</button>
          <button id="cancelBtn" class="btn-ghost danger" disabled>ุงูุบุงุก</button>
          <div class="eta muted" id="etaText">ETA: โ | ุงูุณุฑุนุฉ: โ ุฑูุงุจุท/ุซ</div>
        </div>
        <div class="progress-wrap"><div id="progressBar" class="progress"></div></div>
        <div class="progress-stats">
          <span id="statCounts">0 / 0</span>
          <span id="statStatus">ูู ุงูุชุธุงุฑ ุงูููู</span>
        </div>

        <div class="actions-row">
          <button id="exportReportBtn" class="btn-secondary" disabled>ุชูุฑูุฑ CSV</button>
          <button id="exportFailuresBtn" class="btn-secondary" disabled>ูุดู ููุท</button>
        </div>

        <div id="log" class="log"></div>
      </section>

      <!-- Dashboard -->
      <section class="card">
        <h3 class="section-title">ููุญุฉ ุณุฑูุนุฉ</h3>
        <div class="dash-grid">
          <div class="kpi"><div class="kpi-title">ุนุฏุฏ ุงูููุชุฌุงุช ูู ุงูููู</div><div class="kpi-value" id="kpi-total-products">โ</div><div class="kpi-foot muted" id="kpi-total-products-note"></div></div>
          <div class="kpi"><div class="kpi-title">ููุชุฌุงุช ูููุง ุฑูุงุจุท</div><div class="kpi-value" id="kpi-products-with-links">โ</div><div class="kpi-foot"><span class="badge" id="kpi-coverage">โ</span></div></div>
          <div class="kpi"><div class="kpi-title">ุงุฌูุงูู ุงูุฑูุงุจุท</div><div class="kpi-value" id="kpi-total-links">โ</div><div class="kpi-foot muted" id="kpi-ext-top">โ</div></div>
          <div class="kpi"><div class="kpi-title">ุงุฌุฒุงุก ZIP ุงููุชููุนุฉ</div><div class="kpi-value" id="kpi-est-parts">โ</div><div class="kpi-foot muted" id="kpi-zip-limits">โ</div></div>
        </div>
        <div class="dash-rows small">
          <div class="dash-card"><div class="dash-card-title">ุชูุฒูุน ุงูุงูุชุฏุงุฏุงุช</div><canvas id="extChart" height="150"></canvas></div>
          <div class="dash-card"><div class="dash-card-title">ุงุนูู ุงูุฏููููุงุช</div><canvas id="hostChart" height="150"></canvas></div>
          <div class="dash-card"><div class="dash-card-title">Histogram ูุงุญุฌุงู ุงูุตูุฑ</div><canvas id="sizeChart" height="150"></canvas></div>
          <div class="dash-card">
            <div class="dash-card-title">ุชูุฏูุฑ ุงูุญุฌู</div>
            <div class="size-rows">
              <div class="size-row"><div>ุฑูุงุจุท ุนุฑููุง ุญุฌููุง:</div><div id="known-count">โ</div></div>
              <div class="size-row"><div>ุงุฌูุงูู ูุนุฑูู:</div><div id="known-total">โ</div></div>
              <div class="size-row"><div>ูุชูุณุท ุงูุญุฌู:</div><div id="avg-size">โ</div></div>
              <div class="size-row"><div>ุงุตุบุฑ / ุงูุจุฑ:</div><div id="min-max">โ</div></div>
              <div class="size-row"><div>ุงุฌูุงูู ุชูุฏูุฑู ูุจู ุงูุถุบุท:</div><div id="est-total">โ</div></div>
              <div class="size-row"><div>ุงุฌูุงูู ุชูุฏูุฑู ุฏุงุฎู ZIP:</div><div id="est-zip">โ</div></div>
              <div class="meter-wrap"><div class="meter-label">ูุณุจุฉ ุงูุฑูุงุจุท ุงููู ุนุฑููุง ุญุฌููุง</div><div class="meter"><div class="meter-bar" id="known-meter" style="width:0%"></div></div></div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- RIGHT -->
    <aside class="col side">
      <!-- Google Drive (hidden until chosen) -->
      <section id="driveCard" class="card hidden">
        <h3 class="section-title">ุฑูุน ุฅูู Google Drive</h3>
        <div class="field"><label for="remoteEndpoint">ุฑุงุจุท Web App</label>
          <input id="remoteEndpoint" type="url" placeholder="https://script.google.com/macros/s/.../exec"
                 value="https://script.google.com/macros/s/AKfycbxo4ftgGcCaY_TBkMZvgGepiGneDWInZKEKrKl_H0OSQkkDiTIhv6gg3pLJnb9JGFR9_g/exec">
        </div>
        <div class="field"><label for="remoteFolderLink">ุฑุงุจุท ูุฌูุฏ (ุงุฎุชูุงุฑู)</label>
          <input id="remoteFolderLink" type="url" placeholder="https://drive.google.com/drive/folders/...">
        </div>
        <div class="grid two">
          <div class="field"><label for="remoteSession">ุงุณู ูุฌูุฏ ุฌูุณุฉ (ุงุฎุชูุงุฑู)</label><input id="remoteSession" type="text" placeholder="session-YYYYMMDD"></div>
          <div class="field"><label for="remoteConcurrency">ุฑูุน ูุชูุงุฒู</label><input id="remoteConcurrency" type="number" min="1" max="4" value="2"></div>
        </div>
        <div class="actions-row">
          <button id="uploadZipsBtn" class="btn-secondary" disabled>ุงุฑูุน ูููุงุช ZIP</button>
          <button id="uploadPicsBtn" class="btn-secondary" disabled>ุงุฑูุน ุงูุตูุฑ ูุจุงุดุฑุฉ</button>
          <button id="testUploadBtn" class="btn-ghost">ุงุฎุชุจุงุฑ ุงูุฑูุน</button>
        </div>

<!-- ุถุน ูุฐุง ุฏุงุฎู ูุฑุช Google Drive ุจุฏู ูุชูุฉ ุงูุชุตุฏูุฑ ุงููุฏููุฉ -->
<div class="group-title">ุชุตุฏูุฑ ุฑูุงุจุท ุงูุตูุฑ (Excel)</div>
<div class="grid two">
  <label class="chk">
    <input id="xlOnePerCode" type="checkbox">
    <span>ุตู ูุงุญุฏ ููู ููุชุฌ</span>
  </label>
  <div class="field actions-row">
    <button id="exportDrivePicsXlsx" class="btn-ghost" disabled>ุชุตุฏูุฑ ุฑูุงุจุท ุงูุตูุฑ</button>
  </div>
</div>

        <div id="zipList" class="muted" style="margin-top:8px"></div>
      </section>

      <!-- Settings (simple/advanced) -->
      <section class="card" id="settingsCard">
        <h3 class="section-title">ุงูุงุนุฏุงุฏุงุช</h3>

        <!-- Simple -->
        <div id="simpleBlock">
          <div class="group-title">ุณุฑูุน</div>
          <div class="field"><label for="sheetName">ุงุณู ุงูุดูุช (ุงุฎุชูุงุฑู)</label><input id="sheetName" type="text" placeholder="ูู ูุงุถู ููุณุชุฎุฏู ุงูู ุดูุช" /></div>
          <div class="field"><label for="namingPattern">ูุงูุจ ุงูุชุณููุฉ</label>
            <input id="namingPattern" type="text" value="${code}/${code}_${seq}.${ext}" />
            <small class="muted">ุงููุชุบูุฑุงุช: <code>${code}</code> ููุฏ ุงูููุชุฌุ <code>${seq}</code> ุฑููุ <code>${ext}</code> ุงูุชุฏุงุฏ</small>
          </div>
          <label class="checkbox"><input id="groupByProduct" type="checkbox" /><span>ูุฌูุฏ ููู ููุชุฌ</span></label>
          <div class="grid two">
            <div class="field"><label for="maxZipFiles">ุงูุตู ูููุงุช ูู ZIP</label><input id="maxZipFiles" type="number" min="50" value="300" /></div>
            <div class="field"><label for="maxZipMB">ุงูุตู ุญุฌู ZIP (MB)</label><input id="maxZipMB" type="number" min="50" value="200" /></div>
          </div>
        </div>

        <!-- Advanced -->
        <div id="advancedBlock" class="hidden">
          <div class="group-title">ุฃุฏุงุก</div>
          <div class="grid two">
            <div class="field"><label for="concurrency">ุงูุชุญูููุงุช ุงููุชูุงุฒูุฉ</label><input id="concurrency" type="number" min="1" max="12" value="6" /></div>
            <div class="field"><label for="perHost">ุญุฏ ููู ุฏูููู</label><input id="perHost" type="number" min="1" max="8" value="4" /></div>
          </div>
          <div class="field">
            <label for="maxPerProduct">ุญุฏ ุตูุฑ ููู ููุชุฌ (0 = ุจุฏูู ุญุฏ)</label>
            <input id="maxPerProduct" type="number" min="0" value="0" />
          </div>
          <div class="group-title">ููุชุฑุฉ ุงูุฏููููุงุช</div>
          <div class="field"><label for="whitelist">Whitelist</label><input id="whitelist" type="text" placeholder="example.com, img.cdn.com" /></div>
          <div class="field"><label for="blacklist">Blacklist</label><input id="blacklist" type="text" placeholder="bad.host.com" /></div>

          <div class="group-title">ุงุนูุฏุฉ ุงูููู</div>
          <label class="checkbox"><input id="manualSelect" type="checkbox" /><span>ุงุฎุชูุงุฑ ุงูุงุนูุฏุฉ ูุฏูู</span></label>
          <div class="actions-row"><button id="previewBtn_side" class="btn-ghost" disabled>ูุชุญ ุงููุนุงููุฉ</button></div>
        </div>
      </section>
    </aside>
  </main>

  <footer class="container footnote">ูู ุธูุฑ CORS ูู ุญุณุงุจ ุงููุณุงุญุฉ ุฃู ุงูุชุญููู ูุงูุณูุฑูุฑ ูุญุชุงุฌ ูุณูุญ ุจุทูุจุงุช ุงููุชุตูุญ.</footer>

  <!-- Help modal -->
  <div id="helpModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-title">ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู</div><button id="helpClose" class="btn-ghost">ุงุบูุงู</button></div>
      <div class="modal-body">
        <ol class="help-steps">
          <li>ุงุฑูุน ููู Excel/CSV. ูุงุฒู ุนููุฏ <b>ููุฏ ุงูููุชุฌ</b> ูุนููุฏ <b>ุฑูุงุจุท ุงูุตูุฑ</b> (ูููู ุงูุชุฑ ูู ุฑุงุจุท ููุตูู ุจููุงุตู).</li>
          <li>ูู ุงูุชุนุฑู ุงูุขูู ุนูู ุงูุฃุนูุฏุฉ ูุด ูุถุจูุทุ ูุนู "ุงุฎุชูุงุฑ ุงูุงุนูุฏุฉ ูุฏูู" ูู ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ ูุญุฏุฏูู.</li>
          <li>ุงุถุบุท <b>ุญุณุงุจ ุงููุณุงุญุฉ</b> ูุนุฑุถ ุชูุฏูุฑ ุงูุญุฌู ูุนุฏุฏ ุงูุฒูุจุงุช ุงููุชููุน.</li>
          <li>ุงุฎุชูุฑ ุงูููุงู: ุชุญููู ูุญููุ ุฑูุน ุตูุฑ ูููุตูุฉุ ู/ุฃู ุฑูุน ZIP. ูู ุงุฎุชุฑุช ููุงู ุฏุฑุงูู ูุชุธูุฑ ุฅุนุฏุงุฏุงุช ุฏุฑุงูู ูููู.</li>
          <li>ุงุถุบุท <b>ุงุจุฏุฃ</b> ูุชูููุฐ ุงูููุงู ุงููุฎุชุงุฑุฉ ุจุงูุชุฑุชูุจ.</li>
        </ol>
        <hr>
        <p><b>ุงููุชุบูุฑุงุช ูู ูุงูุจ ุงูุชุณููุฉ</b></p>
        <ul>
          <li><code>${code}</code>: ููุฏ ุงูููุชุฌ ุจุนุฏ ุงูุชูุธูู.</li>
          <li><code>${seq}</code>: ุฑูู ุงูุตูุฑุฉ ุงูุชุณูุณูู (01ุ 02...).</li>
          <li><code>${ext}</code>: ุงูุชุฏุงุฏ ุงูุตูุฑุฉ (jpg/png...)</li>
          <li>ุชูุฏุฑ ุชุนูู ูุฌูุฏุงุช ุจูุชุงุจุฉ <code>/</code> ุฏุงุฎู ุงููุงูุจุ ูุซู: <code>${code}/${code}_${seq}.${ext}</code></li>
        </ul>
        <p><b>ูุตุงุฆุญ ุงูุฃุฏุงุก</b></p>
        <ul>
          <li>ุงูุชุญูููุงุช ุงููุชูุงุฒูุฉ: 4โ8 ููุงุณุจูู.</li>
          <li>ุญุฏ ููู ุฏูููู: ูููุน ุงูุถุบุท ุนูู ุณูุฑูุฑ ูุงุญุฏ.</li>
          <li>ุชูุณูู ZIP: ุจุงูุนุฏุฏ ุฃู ุจุงูุญุฌู (ุฃูููุง ูุชุญูู ุฃูููุง).</li>
          <li>Whitelist/Blacklist: ูุชูููุฏ/ุงุณุชุจุนุงุฏ ุฏููููุงุช.</li>
        </ul>
        <p class="muted">ุฑูุน ุฌูุฌู ุฏุฑุงูู: ุงูุดุฑ Web App ูู ุญุณุงุจู (Execute as: Me, Access: Anyone). ุฒุฑ "ุงุฎุชุจุงุฑ ุงูุฑูุน" ูุคูุฏ ุงูุฅุนุฏุงุฏ.</p>
      </div>
    </div>
  </div>

  <!-- Preview modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-title">ุงููุนุงููุฉ ูุงุฎุชูุงุฑ ุงูุงุนูุฏุฉ</div><button id="modalClose" class="btn-ghost">ุงุบูุงู</button></div>
      <div class="modal-body">
        <div class="grid two">
          <div class="field"><label for="codeCol">ุนููุฏ ุงูููุฏ</label><select id="codeCol"></select></div>
          <div class="field"><label for="linksCol">ุนููุฏ ุงูุฑูุงุจุท</label><select id="linksCol"></select></div>
        </div>
        <div class="preview-tabs"><button id="tabRows" class="tab active">ุตููู</button><button id="tabPics" class="tab">ุตูุฑ</button></div>
        <div id="previewRows" class="preview-table"></div>
        <div id="previewPics" class="pics-grid hidden"></div>
      </div>
      <div class="modal-footer"><button id="applyColsBtn">ุชุฃููุฏ</button></div>
    </div>
  </div>

  <div id="toasts" class="toasts"></div>
  <script src="script.js"></script>
</body>
</html>
